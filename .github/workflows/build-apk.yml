name: Build APK

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          python3-pip python3-setuptools python3-venv git \
          openjdk-17-jdk zip unzip build-essential autoconf automake libtool autoconf-archive pkg-config

    - name: Update git submodules
      run: git submodule update --init --recursive

    - name: Create virtual environment
      run: python3 -m venv venv

    - name: Activate venv and install Buildozer
      run: |
        source venv/bin/activate
        pip install --upgrade pip
        pip install buildozer cython setuptools

    - name: Run Buildozer once to generate platform folder
      run: |
        source venv/bin/activate
        buildozer android debug || true

    - name: Patch libffi macros
      run: |
        echo "ðŸ”§ Ð˜Ñ‰ÐµÐ¼ configure.ac Ð¸ Ð¿Ð°Ñ‚Ñ‡Ð¸Ð¼ LT_SYS_SYMBOL_USCORE..."
        FILES=$(find .buildozer/android/platform -name "configure.ac")
        if [ -z "$FILES" ]; then
          echo "âš ï¸ configure.ac Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ â€” Ð¿Ð°Ñ‚Ñ‡ Ð½Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ñ‘Ð½"
        else
          echo "âœ… ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ $(echo "$FILES" | wc -l) Ñ„Ð°Ð¹Ð»(Ð¾Ð²) â€” Ð²Ð½Ð¾ÑÐ¸Ð¼ Ð¿Ñ€Ð°Ð²ÐºÐ¸..."
          echo "$FILES" | while read FILE; do
            sed -i '1im4_pattern_allow([^LT_SYS_SYMBOL_USCORE$])' "$FILE"
            echo "  ðŸ”§ ÐŸÑ€Ð¾Ð¿Ð°Ñ‚Ñ‡ÐµÐ½: $FILE"
          done
          echo "ðŸŽ‰ ÐŸÐ°Ñ‚Ñ‡ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ñ‘Ð½"
        fi

    - name: Patch all pyjnius files (long â†’ int)
      run: |
        echo "ðŸ”§ Ð˜Ñ‰ÐµÐ¼ pyjnius .pxi/.pyx Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸ Ð¿Ð°Ñ‚Ñ‡Ð¸Ð¼ (long -> int)..."
        FILES=$(find .buildozer -type f -path "*/pyjnius/*" \( -name "*.pxi" -o -name "*.pyx" \) -print)
        if [ -z "$FILES" ]; then
          echo "âš ï¸ Ð¤Ð°Ð¹Ð»Ñ‹ pyjnius Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð² .buildozer â€” Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾, Ð¿ÐµÑ€Ð²Ñ‹Ð¹ buildozer Ð½Ðµ Ð´Ð¾ÐºÐ°Ñ‡Ð°Ð» Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸."
        else
          echo "âœ… ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
          echo "$FILES"
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            echo "  ðŸ”§ ÐŸÐ°Ñ‚Ñ‡Ð¸Ð¼: $f"
            # Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð·Ð°Ð¼ÐµÐ½Ñ‹
            sed -i 's/isinstance(arg, long)/isinstance(arg, int)/g' "$f" || true
            sed -i 's/isinstance(py_arg, (int, long))/isinstance(py_arg, int)/g' "$f" || true
            sed -i -E "s/isinstance\(([^\),]+),\s*\(int,\s*long\)\)/isinstance(\1, int)/g" "$f" 2>/dev/null || true
            sed -i 's/(int, long)/(int)/g' "$f" || true
            sed -i 's/, long\)/)/g' "$f" || true
            sed -i 's/,\s*long\]/]/g' "$f" || true
          done <<< "$FILES"
          echo "ðŸŽ‰ ÐŸÐ°Ñ‚Ñ‡Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ pyjnius Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾."
        fi
        echo "ðŸ”Ž ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°: Ð¾ÑÑ‚Ð°Ð²ÑˆÐ¸ÐµÑÑ ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ 'long' Ð² pyjnius (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 50 ÑÑ‚Ñ€Ð¾Ðº):"
        grep -R --line-number --color=always "long" .buildozer | head -n 50 || echo "âœ… ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ÑÐ²Ð½Ñ‹Ñ… ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ð¹ 'long' Ð² .buildozer (Ð¸Ð»Ð¸ output Ð¿ÑƒÑÑ‚)."

    - name: Build APK (second run)
      run: |
        source venv/bin/activate
        buildozer android debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: TestApp-APK
        path: bin/*.apk
